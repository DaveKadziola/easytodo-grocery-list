<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <!-- Viewport tag for responsive behavior -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Easy ToDo & Grocery List</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #343a40;
      color: #ffffff;
    }
    .task-done {
      text-decoration: line-through;
    }
    .task-item {
      cursor: pointer;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }
    /* Highlight class during dragging – 4.5px red border */
    .highlighted {
      border: 4.5px solid red !important;
    }
    .masonry-container {
      width: 100%;
    }
    @media (min-width: 768px) and (max-width: 990px){
      .masonry-container {
        width: 100%;
        margin: 0 auto;
        column-count: 2;
        column-gap: 1rem;
      }
    }
    @media (min-width: 991px){
      .masonry-container {
        width: 100%;
        margin: 0 auto;
        column-count: 3;
        column-gap: 1rem;
        scroll-behavior: smooth;
        transition: scroll-top 0.5s ease-in-out;
      }
    }
    .category-block {
      display: inline-block;
      width: 100%;
      margin-bottom: 1rem;
      transition: transform 0.5s ease-in-out, opacity 0.3s ease;
    }
    /* Move category arrow buttons */
    .move-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0 2px;
      margin: 0 2px;
    }
    .move-btn:disabled {
      color: gray;
      cursor: default;
    }
    /* Desktop category form – full-width at the top */
    .new-category-desktop { display: none; }
    .new-category-mobile { display: none; }
    @media (min-width: 768px) {
      .new-category-desktop { display: block; }
    }
    @media (max-width: 767.98px) {
      .new-category-mobile { display: block; }
    }

    @media (max-width: 767.98px) {
    .new-category-mobile .form-control::placeholder {
      color: #adb5bd;
      opacity: 1;
      }
    }
  .task-done {
    text-decoration: line-through;
    opacity: 0.6;
  }

  .card-body {
      transition: opacity 0.3s ease-in-out;
  }

  @keyframes task-highlight {
      0% {
          background: rgba(255, 165, 0, 0.3);
          transform: scale(1);
      }
      50% {
          background: rgba(255, 165, 0, 0.7);
          transform: scale(1.02);
      }
      100% {
          background: transparent;
          transform: scale(1);
      }
  }
  .task-highlight {
    animation: task-highlight 1.5s ease-out;
  }


  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="mb-4">Easy ToDo & Grocery List</h1>

  <!-- Desktop category form – full-width at the top -->
  <div class="row new-category-desktop mb-4">
    <div class="col-12">
      <div class="card bg-secondary">
        <div class="card-body">
          <form method="POST"
                action="{{ url_for('add_category') }}"
                onsubmit="addCategory(event)">
            <div class="input-group">
              <input type="text" name="category_name" class="form-control" placeholder="Dodaj nową kategorię" required>
              <button class="btn btn-outline-light" type="submit">Dodaj kategorię</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Masonry layout container for categories -->
  <div class="masonry-container">
    <div id="categoriesMasonry">
      {% for category in categories %}
      <div class="category-block" id="category{{ category.id }}" draggable="true"
           ondragstart="dragCategory(event, {{ category.id }})"
           ondragover="allowDropCategory(event)"
           ondragenter="highlightCategory(event)"
           ondragleave="removeHighlight(event)"
           ondrop="dropCategory(event, {{ category.id }})">
        <div class="card bg-secondary">
          <div class="card-header d-flex justify-content-between align-items-center">
            <a data-bs-toggle="collapse" href="#collapseCategory{{ category.id }}" role="button" aria-expanded="true" aria-controls="collapseCategory{{ category.id }}" class="text-white text-decoration-none col">
              {{ category.name }}
            </a>
            <div class="d-flex align-items-center">
              <!-- Arrow buttons for category position change -->
              <button class="btn btn-outline-secondary move-btn" id="moveCategory_{{ category.id }}" onclick="moveCategory({{ category.id }}, 'up')" {% if loop.first %}disabled{% endif %}>&#8593;</button>
              <button class="btn btn-outline-secondary move-btn" id="moveCategory_{{ category.id }}" onclick="moveCategory({{ category.id }}, 'down')" {% if loop.last %}disabled{% endif %}>&#8595;</button>
              <div class="dropdown">
                <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  &#x22EE;
                </button>
                <ul class="dropdown-menu dropdown-menu-dark">
                  <li>
                    <a class="dropdown-item" href="#" onclick="renameCategory({{ category.id }}, '{{ category.name }}')">Zmień nazwę</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="deleteCategory({{ category.id }})">Usuń kategorię</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="collapse show" id="collapseCategory{{ category.id }}">
            <div class="card-body" ondragover="allowDrop(event)" ondrop="dropTask(event, {{ category.id }})">
              {% set tasks = tasks_by_category.get(category.id, []) %}
              {% for task in tasks %}
              <div class="form-check mb-2" id="taskBlock{{ task.id }}" draggable="true" ondragstart="dragTask(event, {{ task.id }})">
                <!-- Checkbox for task -->
                <input class="form-check-input" type="checkbox" id="taskCheckbox{{ task.id }}" onchange="toggleTask({{ task.id }})" {% if task.is_done %}checked{% endif %}>
                <span class="form-check-label task-item {% if task.is_done %}task-done{% endif %}" onclick="openTaskModal({{ task.id }}, '{{ task.name }}', '{{ task.description|default('') }}'); event.stopPropagation();">
                 <div class="col"> {{ task.name }}</div>
                </span>
              </div>
              {% endfor %}
              <!-- Task form -->
              <form method="POST" action="{{ url_for('add_task') }}"
              id="addTaskForm{{ category.id }}"
              onsubmit="addTask(event, {{ category.id }})">
                <div class="input-group mt-3">
                  <input type="hidden" name="category_id" value="{{ category.id }}">
                  <input type="text" id="newTask_{{ category.id }}" name="task_name" class="form-control" placeholder="Dodaj nowe zadanie" required>
                  <button class="btn btn-outline-light" type="submit">Dodaj</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <!-- Mobile category form – at the bottom -->
    <div class="new-category-mobile mt-4">
      <div class="card bg-secondary">
        <div class="card-body">
          <form method="POST"
                action="{{ url_for('add_category') }}"
                onsubmit="addCategory(event)">
            <div class="input-group">
              <input type="text" id="newCategory" name="category_name" class="form-control" placeholder="Dodaj nową kategorię" required>
              <button class="btn btn-outline-light" type="submit">Dodaj kategorię</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for task details -->
<div class="modal fade" id="taskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="taskModalTitle">Szczegóły zadania</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="taskForm">
          <div class="mb-3">
            <label for="taskName" class="form-label">Nazwa zadania</label>
            <input type="text" class="form-control" id="taskName" name="name">
          </div>
          <div class="mb-3">
            <label for="taskDescription" class="form-label">Notatka</label>
            <textarea class="form-control" id="taskDescription" name="description"></textarea>
          </div>
          <input type="hidden" id="currentTaskId">
        </form>
      </div>
      <div class="modal-footer d-flex flex-nowrap">
        <button type="button" class="btn btn-secondary text-nowrap ms-auto" data-bs-dismiss="modal">Anuluj</button>
        <button type="button" class="btn btn-danger text-nowrap" onclick="deleteTask()">Usuń zadanie</button>
        <button type="button" class="btn btn-primary text-nowrap me-auto" onclick="saveTask()">Zapisz zmiany</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
<script>
  // Functions for task handling
// Zmodyfikowana funkcja toggleTask
function toggleTask(taskId) {
    var checkbox = document.getElementById('taskCheckbox' + taskId);
    var categoryBlock = checkbox.closest('.category-block');
    var categoryId = categoryBlock.id.replace('category', '');

    fetch('/toggle_task/' + taskId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_done: checkbox.checked })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Pobierz zaktualizowaną listę zadań i odśwież widok
            fetch(`/get_tasks_by_category/${categoryId}`)
                .then(response => response.json())
                .then(tasks => updateTasksView(categoryId, tasks))
                .catch(error => console.error('Błąd pobierania zadań:', error));
        } else {
            throw new Error('Błąd aktualizacji statusu');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !checkbox.checked;
        alert('Wystąpił błąd: ' + error.message);
    });
}

function updateTasksView(categoryId, tasks) {
    const cardBody = document.querySelector(`#category${categoryId} .card-body`);
    const taskForm = document.querySelector(`#addTaskForm${categoryId}`); // Wybierz formularz po ID
    const animationDuration = 300;

    // Animacja zanikania
    cardBody.style.transition = `opacity ${animationDuration}ms`;
    cardBody.style.opacity = '0';

    setTimeout(() => {
        // Usuń tylko zadania, zachowując formularz
        const childrenToRemove = Array.from(cardBody.children).filter(child => child.id !== `addTaskForm${categoryId}`);
        childrenToRemove.forEach(child => child.remove());

        // Sortowanie zadań
        tasks.sort((a, b) => a.is_done - b.is_done || a.name.localeCompare(b.name));

        // Dodawanie zadań przed formularzem
        tasks.forEach(task => {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'form-check mb-2';
            taskDiv.id = `taskBlock${task.id}`;
            taskDiv.draggable = true;
            taskDiv.ondragstart = (e) => dragTask(e, task.id);

            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input';
            checkbox.type = 'checkbox';
            checkbox.id = `taskCheckbox${task.id}`;
            checkbox.checked = task.is_done;
            checkbox.onchange = () => toggleTask(task.id);

            const span = document.createElement('span');
            span.className = `form-check-label task-item ${task.is_done ? 'task-done' : ''}`;
            span.onclick = (e) => {
                e.stopPropagation();
                openTaskModal(task.id, task.name, task.description);
            };

            const colDiv = document.createElement('div');
            colDiv.className = 'col';
            colDiv.textContent = task.name;

            span.appendChild(colDiv);
            taskDiv.appendChild(checkbox);
            taskDiv.appendChild(span);
            cardBody.insertBefore(taskDiv, taskForm);
        });

        // Animacja pojawiania się
        cardBody.style.opacity = '1';
    }, animationDuration);

    console.log(`Aktualizacja kategorii ${categoryId}`, tasks);
}





async function addTask(event, categoryId) {
    event.preventDefault();
    const form = event.target;

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form)
        });

        if (!response.ok) {
            throw new Error('Błąd sieciowy');
        }

        const data = await response.json();

        if (data.status === 'success') {
            // Fetch the task template
            const templateResponse = await fetch('static/task_template.html');
            let templateHtml = await templateResponse.text();

            // Replace placeholders with actual data
            templateHtml = templateHtml.replace(/\${taskId}/g, data.task_id)
                .replace(/\${taskName}/g, data.task_name)
                .replace(/\${isDone}/g, data.is_done)
                .replace(/\${taskDescription}/g, data.description);

            const taskList = document.querySelector(`#category${categoryId} .card-body`);
            taskList.insertAdjacentHTML('afterbegin', templateHtml);

            form.reset();
        } else {
            alert('Błąd dodawania zadania: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Błąd dodawania zadania: ' + error.message);
    }
}




  function openTaskModal(taskId, name, description) {
    document.getElementById('currentTaskId').value = taskId;
    document.getElementById('taskName').value = name;
    document.getElementById('taskDescription').value = description;
    var taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
    taskModal.show();
  }

  function saveTask() {
    var taskId = document.getElementById('currentTaskId').value;
    var taskNameInput = document.getElementById('taskName');
    var newName = taskNameInput.value.trim();
    if(newName === ""){
      // Jeśli nazwa jest pusta, zamknij modal bez zmiany
      var modalEl = document.getElementById('taskModal');
      var modalInstance = bootstrap.Modal.getInstance(modalEl);
      if(modalInstance) { modalInstance.hide(); }
      return;
    }
    var formData = new FormData(document.getElementById('taskForm'));
    fetch('/update_task/' + taskId, {
      method: 'POST',
      body: formData
    }).then(response => response.json())
      .then(data => { if(data.status === 'success') { location.reload(); } else { alert('Błąd zapisu'); } });
  }

  function deleteTask() {
    if(confirm('Czy napewno chcesz usunąć zadanie?')) {
      var taskId = document.getElementById('currentTaskId').value;
      fetch('/delete_task/' + taskId, { method: 'POST' })
        .then(response => response.json())
        .then(data => { if(data.status === 'success') { location.reload(); } else { alert('Błąd usunięcia'); } });
    }
  }

  function deleteCategory(categoryId) {
    if(confirm('Czy napewno chcesz usunąć kategorię?')) {
      fetch('/delete_category/' + categoryId, {
        method: 'POST'
      }).then(response => response.json())
        .then(data => {
          if(data.status === 'success') {
            location.reload();
          } else {
            alert('Błąd usunięcia kategorii');
          }
        });
    }
  }

  function renameCategory(categoryId, currentName) {
    var newName = prompt("Podaj nową nazwę kategorii", currentName);
    if(newName) {
      var formData = new FormData();
      formData.append('name', newName);
      fetch('/update_category/' + categoryId, {
        method: 'POST',
        body: formData
      }).then(response => response.json())
        .then(data => {
          if(data.status === 'success') {
            location.reload();
          } else {
            alert('Błąd zmiany nazwy kategorii');
          }
        });
    }
  }

  // Drag'n'drop for tasks
  function dragTask(ev, taskId) {
      ev.dataTransfer.setData("text/plain", taskId);
  }

  function allowDrop(ev) {
      ev.preventDefault();
  }

  function dropTask(ev, newCategoryId) {
      ev.preventDefault();
      var taskId = ev.dataTransfer.getData("text/plain");
      fetch('/move_task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'task_id=' + encodeURIComponent(taskId) + '&new_category_id=' + encodeURIComponent(newCategoryId)
      }).then(response => response.json())
        .then(data => { if(data.status === 'success'){ location.reload(); } else { alert('Błąd przenoszenia zadania'); } });
  }

  // Change category position
  function moveCategory(categoryId, direction) {
    fetch('/move_category', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'category_id=' + encodeURIComponent(categoryId) + '&direction=' + encodeURIComponent(direction)
    }).then(response => response.json())
      .then(data => { if(data.status === 'success'){
      window.location.hash = '#category' + categoryId;
      location.reload();
      }
      else { alert('Błąd zmiany kolejności kategorii'); } });
  }










function addCategory(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const masonryContainer = document.getElementById('categoriesMasonry');
            const newCategoryHtml = `
                <div class="category-block" id="category${data.category_id}" draggable="true"
                     ondragstart="dragCategory(event, ${data.category_id})"
                     ondragover="allowDropCategory(event)"
                     ondragenter="highlightCategory(event)"
                     ondragleave="removeHighlight(event)"
                     ondrop="dropCategory(event, ${data.category_id})">
                    <div class="card bg-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <a data-bs-toggle="collapse" href="#collapseCategory${data.category_id}" role="button" aria-expanded="true" aria-controls="collapseCategory${data.category_id}" class="text-white text-decoration-none">
                                ${data.category_name}
                            </a>
                            <div class="d-flex align-items-center">
                                <button class="move-btn" id="moveCategory_${data.category_id}" onclick="moveCategory(${data.category_id}, 'up')">&#8593;</button>
                                <button class="move-btn" id="moveCategory_${data.category_id}" onclick="moveCategory(${data.category_id}, 'down')">&#8595;</button>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        &#x22EE;
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="renameCategory(${data.category_id}, '${data.category_name}')">Zmień nazwę</a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="deleteCategory(${data.category_id})">Usuń kategorię</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="collapse show" id="collapseCategory${data.category_id}">
                            <div class="card-body" ondragover="allowDrop(event)" ondrop="dropTask(event, ${data.category_id})">
                                <form method="POST" action="/add_task"
                                id="addTaskForm${data.category_id}"
                                onsubmit="addTask(event, ${data.category_id})">
                                    <div class="input-group mt-3">
                                        <input type="hidden" name="category_id" value="${data.category_id}">
                                        <input type="text" id="newTask_${data.category_id}" name="task_name" class="form-control" placeholder="Dodaj nowe zadanie" required>
                                        <button class="btn btn-outline-light" type="submit">Dodaj</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            masonryContainer.insertAdjacentHTML('beforeend', newCategoryHtml);
            form.reset();
        } else {
            alert('Błąd dodawania kategorii: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Błąd dodawania kategorii: ' + error.message);
    });
}








  // Dodatkowa obsługa po załadowaniu strony
  document.addEventListener('DOMContentLoaded', function() {
      if(window.location.hash) {
          const element = document.querySelector(window.location.hash);
          if(element) {
              setTimeout(() => {
                  element.scrollIntoView({behavior: 'smooth', block: 'start', inline: 'nearest'});
              }, 100);
          }
      }
});


const socket = io('http://192.168.100.18:8100', {  // Twój lokalny IPv4
    reconnection: true,
    transports: ['websocket'],
    upgrade: false
});

socket.on('connect', () => {
    console.log('Połączono z serwerem WebSocket');
});

socket.on('update', (data) => {
    console.log('Otrzymano aktualizację:', data);
    if (data.category_id) {
        fetch(`/get_tasks_by_category/${data.category_id}`)
            .then(response => response.json())
            .then(tasks => {
                updateTasksView(data.category_id, tasks);
                setTimeout(() => {
                    if (data.task_id) {
                        highlightUpdatedTask(data.task_id);
                    }
                }, 500);
            })
            .catch(error => console.error('Błąd aktualizacji:', error));
    }

});

function highlightUpdatedTask(taskId) {
    const taskElement = document.getElementById(`taskBlock${taskId}`);
    if (!taskElement) {
        console.error(`Element #task-${taskId} nie istnieje`);
        return;
    }

    // Reset animacji
    taskElement.classList.remove('task-highlight');

    taskElement.classList.add('task-highlight');

    taskElement.addEventListener('animationend', () => {
        taskElement.classList.remove('task-highlight');
    }, {once: true});
}

/*
socket.on('connection_status', (data) => {
    console.log('Status połączenia:', data.status);
    console.log('SID:', data.sid);
});



socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    if (data.type === 'update') {
        fetch(`/get_tasks_by_category/${data.category_id}`)
            .then(response => response.json())
            .then(tasks => updateTasksView(data.category_id, tasks))
            .catch(error => console.error('Błąd aktualizacji:', error));
    }
};

socket.on('update', (data) => {
    console.log('Otrzymano aktualizację:', data);
    if (data.type === 'task_toggled') {
        const checkbox = document.querySelector(`#task-${data.task_id} input[type="checkbox"]`);
        if (checkbox) {
            checkbox.checked = data.is_done;
        }
    }
});*/


</script>
</body>
</html>
